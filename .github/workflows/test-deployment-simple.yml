name: Test Deployment Setup

on:
  workflow_dispatch:

jobs:
  test-secrets:
    name: Test GitHub Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Test Secret Access
      run: |
        echo "ðŸ” Testing secret access..."
        
        # Test if secrets are accessible (without revealing values)
        if [ -n "${{ secrets.VPS_HOST }}" ]; then
          echo "âœ… VPS_HOST is configured"
        else
          echo "âŒ VPS_HOST is missing"
        fi
        
        if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "âœ… SSH_PRIVATE_KEY is configured"
        else
          echo "âŒ SSH_PRIVATE_KEY is missing"
        fi
        
        if [ -n "${{ secrets.SSH_PORT }}" ]; then
          echo "âœ… SSH_PORT is configured: ${{ secrets.SSH_PORT }}"
        else
          echo "âš ï¸ SSH_PORT not configured, will default to 22"
        fi
        
        if [ -n "${{ secrets.VPS_USER }}" ]; then
          echo "âœ… VPS_USER is configured: ${{ secrets.VPS_USER }}"
        else
          echo "âš ï¸ VPS_USER not configured, will default to root"
        fi
        
        echo "ðŸŽ¯ Secrets test completed"

  test-ssh-key:
    name: Test SSH Key Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: test-secrets
    
    steps:
    - name: Validate SSH Key
      run: |
        echo "ðŸ” Testing SSH key format..."
        
        # Create SSH key file
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/test_key
        chmod 600 ~/.ssh/test_key
        
        # Test key format
        if ssh-keygen -l -f ~/.ssh/test_key; then
          echo "âœ… SSH private key format is valid"
        else
          echo "âŒ SSH private key format is invalid"
          exit 1
        fi
        
        # Test key type
        key_type=$(ssh-keygen -l -f ~/.ssh/test_key | awk '{print $4}')
        echo "ðŸ”‘ Key type: $key_type"
        
        # Clean up
        rm ~/.ssh/test_key
        echo "ðŸŽ¯ SSH key test completed"

  test-vps-connection:
    name: Test VPS Connection
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: test-ssh-key
    
    steps:
    - name: Test SSH Connection
      run: |
        echo "ðŸ” Testing VPS connection..."
        
        # Setup SSH
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Add known hosts
        if [ -n "${{ secrets.KNOWN_HOSTS }}" ]; then
          echo "${{ secrets.KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          echo "âœ… Known hosts configured"
        else
          echo "âš ï¸ No known_hosts configured, will skip StrictHostKeyChecking"
        fi
        
        # Test connection
        VPS_HOST="${{ secrets.VPS_HOST }}"
        VPS_USER="${{ secrets.VPS_USER || 'root' }}"
        VPS_PORT="${{ secrets.SSH_PORT || '22' }}"
        
        echo "ðŸ“¡ Testing connection to $VPS_USER@$VPS_HOST:$VPS_PORT"
        
        if [ -n "${{ secrets.KNOWN_HOSTS }}" ]; then
          # Use strict host key checking
          if ssh -p "$VPS_PORT" -o ConnectTimeout=10 -o StrictHostKeyChecking=yes "$VPS_USER@$VPS_HOST" 'echo "âœ… SSH connection successful with strict checking"'; then
            echo "ðŸŽ‰ VPS connection test PASSED with strict security"
          else
            echo "âŒ VPS connection test FAILED with strict checking"
            exit 1
          fi
        else
          # Test without strict checking as fallback
          if ssh -p "$VPS_PORT" -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$VPS_USER@$VPS_HOST" 'echo "âœ… SSH connection successful (no strict checking)"'; then
            echo "âš ï¸ VPS connection works but without strict host checking"
            echo "ðŸ’¡ Consider adding KNOWN_HOSTS secret for better security"
          else
            echo "âŒ VPS connection test FAILED"
            exit 1
          fi
        fi
        
        echo "ðŸŽ¯ Connection test completed"

  deployment-readiness:
    name: Deployment Readiness Summary
    runs-on: ubuntu-latest
    needs: [test-secrets, test-ssh-key, test-vps-connection]
    if: always()
    
    steps:
    - name: Generate Summary
      run: |
        echo "## ðŸš€ Deployment Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.test-secrets.result }}" == "success" ]; then
          echo "âœ… **Secrets Test**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Secrets Test**: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.test-ssh-key.result }}" == "success" ]; then
          echo "âœ… **SSH Key Test**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **SSH Key Test**: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.test-vps-connection.result }}" == "success" ]; then
          echo "âœ… **VPS Connection Test**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **VPS Connection Test**: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.test-secrets.result }}" == "success" ] && [ "${{ needs.test-ssh-key.result }}" == "success" ] && [ "${{ needs.test-vps-connection.result }}" == "success" ]; then
          echo "ðŸŽ‰ **Overall Status**: READY FOR DEPLOYMENT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your GitHub Actions deployment setup is fully configured and tested!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Overall Status**: NEEDS ATTENTION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the failed tests above and fix any issues." >> $GITHUB_STEP_SUMMARY
        fi